<html lang='en'>
<head>

    <title>Visua-Learn</title>

    <link href='fonts/open-sans.css' rel='stylesheet' type='text/css'>
    <link href='fonts/pt-serif-italics.css' rel='stylesheet' type='text/css'>
    <link href='fonts/font-awesome.css' rel='stylesheet' type='text/css'>
    <link href='css/bootstrap.min.css' rel='stylesheet' type='text/css'>

    <link href='metricsgraphics/metricsgraphics.css' rel='stylesheet' type='text/css'>
    
    <link href='css/interactive.css' rel='stylesheet' type='text/css'>

    <script src='js/jquery.min.js'></script>
    <script src='js/d3.min.js' charset='utf-8'></script>
    <script src="js/lib/ace.js" charset="utf-8"></script>
    <script src="js/bootstrap.min.js"></script>
    <!-- dev start -->
    <script src='metricsgraphics/js/MG.js'></script>
    <script src='metricsgraphics/js/common/data_graphic.js'></script>
    <script src='metricsgraphics/js/common/hooks.js'></script>
    <script src='metricsgraphics/js/common/register.js'></script>
    <script src='metricsgraphics/js/common/bootstrap_tooltip_popover.js'></script>
    <script src='metricsgraphics/js/common/chart_title.js'></script>
    <script src='metricsgraphics/js/common/y_axis.js'></script>
    <script src='metricsgraphics/js/common/x_axis.js'></script>
    <script src='metricsgraphics/js/common/init.js'></script>
    <script src='metricsgraphics/js/common/markers.js'></script>
    <script src='metricsgraphics/js/common/window_listeners.js'></script>
    <script src='metricsgraphics/js/layout/bootstrap_dropdown.js'></script>
    <script src='metricsgraphics/js/layout/button.js'></script>
    <script src='metricsgraphics/js/charts/line.js'></script>
    <script src='metricsgraphics/js/charts/histogram.js'></script>
    <script src='metricsgraphics/js/charts/point.js'></script>
    <script src='metricsgraphics/js/charts/bar.js'></script>
    <script src='metricsgraphics/js/charts/table.js'></script>
    <script src='metricsgraphics/js/charts/missing.js'></script>
    <script src='metricsgraphics/js/misc/process.js'></script>
    <script src='metricsgraphics/js/misc/smoothers.js'></script>
    <script src='metricsgraphics/js/misc/formatters.js'></script>
    <script src='metricsgraphics/js/misc/transitions.js'></script>
    <script src='metricsgraphics/js/misc/utility.js'></script>
    <script src='metricsgraphics/js/misc/error.js'></script>
    <script src='js/dnd.js'></script>

    <!-- functional graphics -->
    <script src="js/function-plot.js"></script>
    <!-- dev end -->

</head>

<body>

    <div class='container'>
        <!-- graph types -->
        <div class="row tab-content col-xs-12">
        <ul class="nav nav-pills">
            <li><a href='#' id='goto-lines' data-toggle="tab">Lines</a></li>
            <li><a href='#' id='goto-multilines' data-toggle="tab">Multiple Lines</a></li>
            <li><a href='#' id='goto-data' data-toggle="tab">Data</a></li>
            <li><a href='#' id='goto-bars' data-toggle="tab">Bars</a></li>
            <li><a href='#' id='goto-functional' data-toggle="tab">Functional</a></li>    
        </ul>
        <ul class='nav nav-pills topics examples text-center'>
      </div>
      <!-- configuration area -->
        <div class='row main-windows-titles'>
            <div class='col-xs-3'>Data</div>
            <div class='js-title col-xs-5'>
                JavaScript
                <button type='button' class='update btn'>Run</button>
            </div>
<!--             <div class='col-xs-4' id='fields'>
                y_accessor
                <select id="y_accessor">
                </select>
                x_accessor
                <select id="x_accessor">
                </select>
            </div> -->
        </div>
        <div class='row main-windows'>
            <div class='data col-xs-3' id='data'>
                <!-- <textarea></textarea> -->
            </div>
            <div class='js col-xs-5' id='editor'></div>
            <div class='col-xs-3'>
                <div class='result text-center'></div>
                <div class='legend text-center'></div>
                <button class="btn btn-success" id="save_as_svg" value="">
            Save as SVG</button>
            <button class="btn btn-success" id="save_as_png">Save as PNG</button>
            </li>
                <div class="console" id="console"></div>
            </div>
        </div>
        <div class='col-xs-6'>
            <ul>
                <li>
                    <a href='https://github.com/mozilla/metrics-graphics/wiki/List-of-Options#list-of-options' target='_blank'>Metrics-graphics options</a>
                </li>
                <li>
                    <a href='http://maurizzzio.github.io/function-plot/' target='_blank'>Function-plot options</a>
                </li>
            </ul>
            
            
        </div>
      </div>
</div>

    </div>
    <div class='container footer'>
    </div>
    <script> 
    $('#goto-lines').on('click', function() {
            $('.topics').load('charts/lines.htm', function(data) {
                $(".topics").html(data)
        });
    });
    $('#goto-multilines').on('click', function() {
            $('.topics').load('charts/multilines.htm', function(data) {
                $('.topics').html(data)
        });
    });
    $('#goto-data').on('click', function() {
            $('.topics').load('charts/scatters.htm', function(data) {
                $('.topics').html(data)
        });
    });
    $('#goto-bars').on('click', function() {
            $('.topics').load('charts/bars.htm', function(data) {
                $('.topics').html(data)
        });
    });
    $('#goto-functional').on('click', function() {
            $('.topics').load('charts/functional.htm', function(data) {
                $('.topics').html(data)
        });
    });
    
    </script>
    <script> //drag and drop
    var dnd = new DnDFileController('#data', function(files) {  
      var f = files[0];
      var csv = false
      //its a csv, so convert to json
      if (f.type.match('text/csv')) {
        csv = true;
      }

      var reader = new FileReader();
        reader.onloadend = function(e) {
            process = this.result
        if (csv) {
            process = csvJSON(process)
        }
        var result = JSON.parse(process);
        // console.log(result)
        // JSON.stringify(data, null, 2)
        jsonData.setValue(process);

      };
      reader.readAsText(f);

      // read the json and process all of the fields in each element

    });
    </script>
    <script>
        var default_call = 'MG.data_graphic({\n'
            + '  title: "UFO Sightings",\n'
            + '  description: "Yearly UFO sightings from 1945 to 2010.",\n'
            + '  data: JSON.parse(jsonData.getValue()),\n'
            + '  markers: [{\'year\': 1964, \'label\': \'"The Creeping Terror" released\'}],\n'
            + '  width: 400,\n'
            + '  height: 250,\n'
            + '  target: ".result",\n'
            + '  x_accessor: "year",\n'
            + '  y_accessor: "sightings",\n'
            + '  interpolate: "monotone"\n'
            + '});';
        jsonData = ace.edit("data");
        jsonData.getSession().setMode("ace/mode/javascript");
        // jsonData.setValue(default_call);
        jsonData.gotoLine(1);
        jsonData.setHighlightActiveLine(false);

        var editor = ace.edit("editor");
        editor.getSession().setMode("ace/mode/javascript");
        editor.setValue(default_call);
        editor.gotoLine(1);
        editor.setHighlightActiveLine(false);

        d3.json('data/ufo-sightings.json', function(data) {
            jsonData.setValue(JSON.stringify(data, null, 2));
            document.getSelection().removeAllRanges();
            eval(editor.getValue());
        })

        $('.update').on('click', function() {
            $('svg').html('')
            $('.mg-chart-title').hide()
            eval(editor.getValue());
            document.getSelection().removeAllRanges();
        })
    </script>

    <script>
    $("#save_as_svg").click(function() { downloadSVG(); });
    function downloadSVG()
    {
                // Declare Variables
        var margin = {top: 60, right: 60, bottom: 60, left:120},
        width = d3.select("svg").attr("width")
        height = d3.select("svg").attr("height")

        var svg = d3.select("svg")
        // //Create Title 
        // svg.append("text")
        // .attr("x", width / 2 )
        // .attr("y", 0)
        // .style("text-anchor", "middle")
        // .text($('.mg-chart-title').html());

        svg.attr("width", width)
        svg.attr("height", height)
        svg.attr("font-family", "'Helvetica Neue',Helvetica,Arial,sans-serif")
        svg.attr("color", "#333")
        svg.append('g')


        var e = document.createElement('script'); 
        e.setAttribute('src', 'https://nytimes.github.io/svg-crowbar/svg-crowbar.js'); 
        e.setAttribute('class', 'svg-crowbar'); 
        document.body.appendChild(e);
    }
    $("#save_as_png").click(function() {
          var html = d3.select("svg")
                .attr("version", 1.1)
                .attr("xmlns", "http://www.w3.org/2000/svg")
                .node().parentNode.innerHTML;
          var width = d3.select("svg").attr("width")
          var height = d3.select("svg").attr("height")
          // console.log(html);
          var imgsrc = 'data:image/svg+xml;base64,'+ btoa(unescape(encodeURIComponent(html)));  
          saveSVG(imgsrc);
    });

    function saveSVG(imgsrc) {
    // inputValue = prompt("What would you like to call the image?")
      var canvas = document.createElement("canvas");

        canvas.width = d3.select("svg").attr("width")
        canvas.height = d3.select("svg").attr("height")
        context = canvas.getContext("2d");

        var image = new Image;
        image.src = imgsrc;
        
        image.onload = function() {
            console.log(1)
          context.drawImage(image, 0, 0);

          var canvasdata = canvas.toDataURL("image/png");

          var pngimg = '<img src="'+canvasdata+'">'; 
          alert("pngimg", pngimg)
            d3.select("body").html(pngimg);

          var a = document.createElement("a");
          a.download = "name"+".png";
          a.href = canvasdata;
          a.click();
        };
}


    //var csv is the CSV file with headers
    function csvJSON(csv){
     
      var lines=csv.split("\n");
     
      var result = [];
     
      var headers=lines[0].split(",");
     
      for(var i=1;i<lines.length;i++){
     
          var obj = {};
          var currentline=lines[i].split(",");
     
          for(var j=0;j<headers.length;j++){
            headers[j] = headers[j].replace(/(?:\\[rn]|[\r\n]+)+/g, ""); 
            if (currentline[j] !== undefined) {
              obj[headers[j]] = currentline[j].replace(/(?:\\[rn]|[\r\n]+)+/g, "");  
            }
          }
     
          result.push(obj);
     
      }
      
      //return result; //JavaScript object
      return JSON.stringify(result,null,2); //JSON
    }
</script>
</body>
</html>
