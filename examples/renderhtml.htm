<html lang='en'>
<head>

    <title>Visua-Learn</title>

    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,700' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=PT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>
    <link href='https://netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css' rel='stylesheet' type='text/css'>
    <link href='https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css' rel='stylesheet' type='text/css'>

    <link href='../dist/metricsgraphics.css' rel='stylesheet' type='text/css'>
    <link href='css/metricsgraphics-demo.css' rel='stylesheet' type='text/css'>
    <link href='css/interactive.css' rel='stylesheet' type='text/css'>

    <script src='https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.0/d3.min.js' charset='utf-8'></script>
    <script src="js/lib/ace.js" charset="utf-8"></script>
    <script src="js/lib/worker-javascript.js" charset="utf-8"></script>
    
    <!-- dev start -->
    <script src='../src/js/MG.js'></script>
    <script src='../src/js/common/data_graphic.js'></script>
    <script src='../src/js/common/hooks.js'></script>
    <script src='../src/js/common/register.js'></script>
    <script src='../src/js/common/bootstrap_tooltip_popover.js'></script>
    <script src='../src/js/common/chart_title.js'></script>
    <script src='../src/js/common/y_axis.js'></script>
    <script src='../src/js/common/x_axis.js'></script>
    <script src='../src/js/common/init.js'></script>
    <script src='../src/js/common/markers.js'></script>
    <script src='../src/js/common/window_listeners.js'></script>
    <script src='../src/js/layout/bootstrap_dropdown.js'></script>
    <script src='../src/js/layout/button.js'></script>
    <script src='../src/js/charts/line.js'></script>
    <script src='../src/js/charts/histogram.js'></script>
    <script src='../src/js/charts/point.js'></script>
    <script src='../src/js/charts/bar.js'></script>
    <script src='../src/js/charts/table.js'></script>
    <script src='../src/js/charts/missing.js'></script>
    <script src='../src/js/misc/process.js'></script>
    <script src='../src/js/misc/smoothers.js'></script>
    <script src='../src/js/misc/formatters.js'></script>
    <script src='../src/js/misc/transitions.js'></script>
    <script src='../src/js/misc/utility.js'></script>
    <script src='../src/js/misc/error.js'></script>
    <script src='http://html5-demos.appspot.com/static/filesystem/filer.js/demos/js/dnd.js'></script>
    <!-- dev end -->
    <link href='css/stylesheet.css' rel='stylesheet' type='text/css'>
</head>

<body>

    <div class='container'>
        <div class='row main-windows-titles'>
            <div class='col-xs-3'>Data</div>
            <div class='js-title col-xs-5'>
                JavaScript
                <button type='button' class='update btn'>Run</button>
            </div>
            <div class='col-xs-3'>render</div>

        </div>
        <div class='row main-windows'>
            <div class='data col-xs-3' id='data'>
            </div>
            <div class='js col-xs-5' id='editor'></div>
            <div class='col-xs-3'>
                <iframe id="view"></iframe>
            </div>
        </div>

    </div>
    <div class='container footer'>
    </div>
    <script> 
    $('#goto-lines').on('click', function() {
            $('.topics').load('charts/lines.htm', function(data) {
                $('.topics').html(data)
        });
    });
    $('#goto-multilines').on('click', function() {
            $('.topics').load('charts/multilines.htm', function(data) {
                $('.topics').html(data)
        });
    });
    $('#goto-data').on('click', function() {
            $('.topics').load('charts/scatters.htm', function(data) {
                $('.topics').html(data)
        });
    });
    $('#goto-bars').on('click', function() {
            $('.topics').load('charts/bars.htm', function(data) {
                $('.topics').html(data)
        });
    });
    </script>
    <script> //drag and drop
    var dnd = new DnDFileController('#data', function(files) {  
      var f = files[0];
      var csv = false
      //its a csv, so convert to json
      if (f.type.match('text/csv')) {
        csv = true;
      }

      var reader = new FileReader();
        reader.onloadend = function(e) {
            process = this.result
            process = JSON.stringify(JSON.parse(process), null, 2);
        if (csv) {
            process = csvJSON(process)
        }
        var result = JSON.parse(process);
        // console.log(result)
        // JSON.stringify(data, null, 2)
        jsonData.setValue(process);

        // var L = result.length;
        // fields = []
        // for (var i = 0; i < L; i++) {
        //     var obj = result[i];
        //     for (var j in obj) {
        //         fields.push(j)
        //     }
        // }
        // $.unique(fields).forEach(function(e) {
        //     $('#y_accessor').append("<option value="+e+">"+e+"</option>")
        //     $('#x_accessor').append("<option value="+e+">"+e+"</option>")
        // })
        // console.log($.unique(fields))
        // $('.data').val(this.result);
      };
      reader.readAsText(f);

      // read the json and process all of the fields in each element

    });
    </script>
    <script>
        var default_call = '<html>\n'
                            + '<head>\n'
                            + '</head>\n'
                            + '<body>\n'
                            + '<h1>hello world</h1>\n'
                            + '<script>\n'
                            + 'document.body.style.backgroundColor = "red";\n'
                            + 'var jon = JSON.parse(parent.jsonData.getValue())\n'
                            + 'for (var v in jon) {\n'
                            + 'document.body.innerHTML = jon[v].name\n'
                            + '}\n'
                            + '<\/script>\n'
                            + '</body>\n'
                            + '</html>\n'
        var retrievedCode = localStorage.getItem('code'); 
        console.log(retrievedCode)
        if (retrievedCode != null) {
            default_call = retrievedCode;
        }                    
        jsonData = ace.edit("data");
        jsonData.getSession().setMode("ace/mode/javascript");
        jsonData.setValue(default_call);
        
        jsonData.setHighlightActiveLine(false);

        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/html");
        // editor.getSession().setMode("ace/mode/html");
        editor.setValue(default_call);
        editor.gotoLine(1);
        editor.setHighlightActiveLine(false);

        var retrievedJson = localStorage.getItem('json');
        if (retrievedJson != null) {
            jsonData.setValue(retrievedJson, null, 2);
        } else {
            d3.json('data/ufo-sightings.json', function(data) {
            jsonData.setValue(JSON.stringify(data, null, 2));
            document.getSelection().removeAllRanges();
            // eval(editor.getValue());
            });
        }
        
        jsonData.gotoLine(1);
        $('.update').on('click', function() {
            var view=$('#view');
            // view.contents().find('html').html(editor.getSession().getValue());
            document.getElementById("view").srcdoc = editor.getSession().getValue();
            localStorage.setItem('code', editor.getSession().getValue());
            localStorage.setItem('json', jsonData.getSession().getValue());
        });
    </script>

    <script>
    function downloadSVG()
    {
                // Declare Variables
        var margin = {top: 60, right: 60, bottom: 60, left:120},
        w = 600 - margin.left - margin.right,
        h = 450 - margin.top - margin.bottom;

        var svg = d3.select("svg")
        svg.attr("width", w + margin.left + margin.right)
        svg.attr("height", h + margin.top + margin.bottom)
        svg.attr("font-family", "'Helvetica Neue',Helvetica,Arial,sans-serif")
        svg.attr("color", "#333")
        svg.append('g')
        svg.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        console.log(MG)
        //Create Title 
        svg.append("text")
        .attr("x", w / 2 )
        .attr("y", 0)
        .style("text-anchor", "middle")
        .text("Title of Diagram");

        var e = document.createElement('script'); 
        e.setAttribute('src', 'https://nytimes.github.io/svg-crowbar/svg-crowbar.js'); 
        e.setAttribute('class', 'svg-crowbar'); 
        document.body.appendChild(e);
    }
    $("#save_as_svg").click(function() { downloadSVG(); });
    </script>
    <script>
    //var csv is the CSV file with headers
    function csvJSON(csv){
     
      var lines=csv.split("\n");
     
      var result = [];
     
      var headers=lines[0].split(",");
     
      for(var i=1;i<lines.length;i++){
     
          var obj = {};
          var currentline=lines[i].split(",");
     
          for(var j=0;j<headers.length;j++){
            headers[j] = headers[j].replace(/(?:\\[rn]|[\r\n]+)+/g, ""); 
            if (currentline[j] !== undefined) {
              obj[headers[j]] = currentline[j].replace(/(?:\\[rn]|[\r\n]+)+/g, "");  
            }
          }
     
          result.push(obj);
     
      }
      
      //return result; //JavaScript object
      return JSON.stringify(result,null,2); //JSON
    }
</script>
</body>
</html>
